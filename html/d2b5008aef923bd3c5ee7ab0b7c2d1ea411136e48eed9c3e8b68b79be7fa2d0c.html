<h2 id="01-contents"><a href="#01-contents">0.1 Contents</a></h2>
<ul>
<li><a href="#1-install-k3s-on-machine-do-not-have-internet-access">1 Install K3S on Machine do not have Internet Access</a>
<ul>
<li><a href="#11-introduction">1.1 Introduction</a></li>
<li><a href="#12-prerequisites">1.2 Prerequisites</a>
<ul>
<li><a href="#121-firewall">1.2.1 Firewall</a></li>
<li><a href="#122-kernel-modules">1.2.2 Kernel Modules</a></li>
</ul>
</li>
<li><a href="#13-solution">1.3 Solution</a></li>
<li><a href="#14-uninstall-k3s">1.4 Uninstall K3S</a>
<ul>
<li><a href="#141-uninstall-k3s-on-server">1.4.1 Uninstall K3S on Server</a></li>
<li><a href="#142-uninstall-k3s-on-agent">1.4.2 Uninstall K3S on Agent</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h1 id="1-install-k3s-on-machine-do-not-have-internet-access"><a href="#1-install-k3s-on-machine-do-not-have-internet-access">1 Install K3S on Machine do not have Internet Access</a></h1>
<h2 id="11-introduction"><a href="#11-introduction">1.1 Introduction</a></h2>
<p>K3S is a lightweight Kubernetes distribution.
It is a great choice for edge computing and IoT devices.
I currently have a machine with only ipv6 access,
and I want to install K3S on it.
Sadly, k3s install script need to download binary from
GitHub, which is known to be not ipv6 friendly currently.</p>
<h2 id="12-prerequisites"><a href="#12-prerequisites">1.2 Prerequisites</a></h2>
<h3 id="121-firewall"><a href="#121-firewall">1.2.1 Firewall</a></h3>
<p>Make sure the machine have open several ports to allow it
to communicate with other nodes.</p>
<pre><code class="hljs language-bash">ufw allow 6443/tcp <span class="hljs-comment">#apiserver</span>
ufw allow from 10.42.0.0/16 to any <span class="hljs-comment">#pods</span>
ufw allow from 10.43.0.0/16 to any <span class="hljs-comment">#services</span>
</code></pre>
<h3 id="122-kernel-modules"><a href="#122-kernel-modules">1.2.2 Kernel Modules</a></h3>
<p>Through trying, I found that the machine need to have
<code>br_netfilter</code> and <code>overlay</code> kernel modules loaded.
Use the following command to check,
if it gives a fatal message,
it probabily means k3s may not supported on this machine.
Also, see <a href="https://github.com/k3s-io/k3s/issues/1236">https://github.com/k3s-io/k3s/issues/1236</a>.</p>
<pre><code class="hljs language-bash">modprobe br_netfilter
modprobe overlay
</code></pre>
<h2 id="13-solution"><a href="#13-solution">1.3 Solution</a></h2>
<p>First, from the k3s release page download the airgap image,
and transfer it to the machine you want to install k3s on.
Then, download the install script from <a href="https://get.k3s.io">https://get.k3s.io</a>,
and put it in the same directory as the airgap image,
and make sure the script is executable.</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">chmod</span> +x install.sh
</code></pre>
<p>Then, download the k3s binary from the release page,
and put it into where ever you install executable,
normally it is <code>/usr/local/bin</code>.</p>
<pre><code class="hljs language-bash"><span class="hljs-built_in">mv</span> k3s /usr/local/bin
<span class="hljs-built_in">chmod</span> +x /usr/local/bin/k3s
</code></pre>
<p>Now, you can run the install script:</p>
<pre><code class="hljs language-bash">INSTALL_K3S_SKIP_DOWNLOAD=<span class="hljs-literal">true</span> INSTALL_K3S_EXEC=<span class="hljs-string">'server --token=SECRET'</span> ./install.sh
</code></pre>
<p>To join another node to the cluster, you can run:</p>
<pre><code class="hljs language-bash">INSTALL_K3S_SKIP_DOWNLOAD=<span class="hljs-literal">true</span> INSTALL_K3S_EXEC=<span class="hljs-string">'server --server https://server-ip:6443 --token=SECRET'</span> ./install.sh
</code></pre>
<h2 id="14-uninstall-k3s"><a href="#14-uninstall-k3s">1.4 Uninstall K3S</a></h2>
<h3 id="141-uninstall-k3s-on-server"><a href="#141-uninstall-k3s-on-server">1.4.1 Uninstall K3S on Server</a></h3>
<pre><code class="hljs language-bash">/usr/local/bin/k3s-uninstall.sh
</code></pre>
<h3 id="142-uninstall-k3s-on-agent"><a href="#142-uninstall-k3s-on-agent">1.4.2 Uninstall K3S on Agent</a></h3>
<pre><code class="hljs language-bash">/usr/local/bin/k3s-agent-uninstall.sh
</code></pre>