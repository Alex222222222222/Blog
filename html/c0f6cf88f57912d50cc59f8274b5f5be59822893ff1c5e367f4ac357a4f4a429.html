<h2 id="01-contents"><a href="#01-contents">0.1 Contents</a></h2>
<ul>
<li><a href="#02-intro">0.2 Intro</a></li>
<li><a href="#03-useful-commands">0.3 Useful Commands</a>
<ul>
<li><a href="#031-rebuild-the-system">0.3.1 Rebuild the System</a></li>
</ul>
</li>
<li><a href="#04-useful-websites">0.4 Useful Websites</a></li>
<li><a href="#05-put-file-under-etc">0.5 Put File Under /etc</a></li>
<li><a href="#06-reference-store-path-of-a-nix-package">0.6 Reference Store Path of a Nix Package</a></li>
<li><a href="#07-use-agenix-to-manage-secrets">0.7 Use Agenix to Manage Secrets</a>
<ul>
<li><a href="#071-install-agenix-via-flakes">0.7.1 Install Agenix Via Flakes</a></li>
<li><a href="#072-get-secrets">0.7.2 Get Secrets</a></li>
<li><a href="#073-mkdir-for-agenix">0.7.3 Mkdir For Agenix</a></li>
<li><a href="#074-add-secrets-keys">0.7.4 Add Secrets Keys</a></li>
<li><a href="#075-add-secrets">0.7.5 Add Secrets</a></li>
<li><a href="#076-add-secrets-to-nixos-configurations">0.7.6 Add Secrets to NixOS Configurations</a></li>
<li><a href="#077-use-secrets">0.7.7 Use Secrets</a>
<ul>
<li><a href="#0771-use-path-of-secrets">0.7.7.1 Use Path of Secrets</a></li>
<li><a href="#0772-replace-inplace-strings-with-secrets">0.7.7.2 Replace Inplace Strings With Secrets</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#08-mount-webdav-using-autofs">0.8 Mount WebDav Using AutoFS</a></li>
<li><a href="#09-clean-the-system--nix-store">0.9 Clean the System &#x26; Nix Store</a></li>
<li><a href="#010-enable-the-mosh-server">0.10 Enable the Mosh Server</a></li>
<li><a href="#011-enable-fail2ban">0.11 Enable Fail2Ban</a></li>
</ul>
<h2 id="02-intro"><a href="#02-intro">0.2 Intro</a></h2>
<p>Some note for NixOS configurations.</p>
<h2 id="03-useful-commands"><a href="#03-useful-commands">0.3 Useful Commands</a></h2>
<h3 id="031-rebuild-the-system"><a href="#031-rebuild-the-system">0.3.1 Rebuild the System</a></h3>
<p>Need <code>sudo</code>.</p>
<pre><code class="hljs language-bash"><span class="hljs-comment"># test the configuration</span>
<span class="hljs-built_in">sudo</span> nixos-rebuild <span class="hljs-built_in">test</span> --flake <span class="hljs-string">"/path/to/config#tag"</span> --show-trace

<span class="hljs-comment"># switch to the configuration</span>
<span class="hljs-built_in">sudo</span> nixos-rebuild switch --flake <span class="hljs-string">"/path/to/config#tag"</span> --show-trace
</code></pre>
<h2 id="04-useful-websites"><a href="#04-useful-websites">0.4 Useful Websites</a></h2>
<p><a href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.etc">NixOS Full Options List</a></p>
<p><a href="https://search.nixos.org">NixOS Package List</a></p>
<p><a href="https://github.com/Alex222222222222.keys">GitHub User Public Key</a></p>
<h2 id="05-put-file-under-etc"><a href="#05-put-file-under-etc">0.5 Put File Under /etc</a></h2>
<p>Check <a href="https://nixos.org/manual/nixos/stable/options.html#opt-environment.etc"> </a></p>
<pre><code class="hljs language-nix">{
    example-configuration-file =
    { 
        source = "./file.conf.example";
        mode = "0440";
    };
    "default/useradd".text = "GROUP=100 ...";
}
</code></pre>
<h2 id="06-reference-store-path-of-a-nix-package"><a href="#06-reference-store-path-of-a-nix-package">0.6 Reference Store Path of a Nix Package</a></h2>
<pre><code class="hljs language-nix">''
${pkgs.hello}/bin/hello
''
</code></pre>
<h2 id="07-use-agenix-to-manage-secrets"><a href="#07-use-agenix-to-manage-secrets">0.7 Use Agenix to Manage Secrets</a></h2>
<p>Check <a href="https://github.com/ryantm/agenix#age-module-reference"><code>agenix GitHub</code></a>.</p>
<h3 id="071-install-agenix-via-flakes"><a href="#071-install-agenix-via-flakes">0.7.1 Install Agenix Via Flakes</a></h3>
<pre><code class="hljs language-nix">{
  inputs.agenix.url = "github:ryantm/agenix";
  # optional, not necessary for the module
  #inputs.agenix.inputs.nixpkgs.follows = "nixpkgs";
  # optionally choose not to download darwin deps (saves some resources on Linux)
  #inputs.agenix.inputs.darwin.follows = "";

  outputs = { self, nixpkgs, agenix }: {
    # change `yourhostname` to your actual hostname
    nixosConfigurations.yourhostname = nixpkgs.lib.nixosSystem {
      # change to your system:
      system = "x86_64-linux";
      modules = [
        ./configuration.nix
        agenix.nixosModules.default
      ];
    };
  };
}
</code></pre>
<h3 id="072-get-secrets"><a href="#072-get-secrets">0.7.2 Get Secrets</a></h3>
<p><code>agenix</code> use <code>ssh keys</code> as keys.</p>
<p>System host <code>ssh key</code> is at <code>/etc/ssh/</code>.</p>
<p>User's <code>ssh key</code> is at <code>~/.ssh</code>.</p>
<h3 id="073-mkdir-for-agenix"><a href="#073-mkdir-for-agenix">0.7.3 Mkdir For Agenix</a></h3>
<pre><code class="hljs language-bash"><span class="hljs-built_in">mkdir</span> -p ./secrets
</code></pre>
<h3 id="074-add-secrets-keys"><a href="#074-add-secrets-keys">0.7.4 Add Secrets Keys</a></h3>
<p>Keys should be put at <code>./secrets/secrets.nix</code>.</p>
<pre><code class="hljs language-nix"># ./secrets/secrets.nix
let
  user1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIL0idNvgGiucWgup/mP78zyC23uFjYq0evcWdjGQUaBH";
  user2 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAILI6jSq53F/3hEmSs+oq9L4TwOo1PrDMAgcA1uo1CCV/";
  users = [ user1 user2 ];

  system1 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIPJDyIr/FSz1cJdcoW69R+NrWzwGK/+3gJpqD1t8L2zE";
  system2 = "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIKzxQgondgEYcLpcPdJLrTdNgZ2gznOHCAxMdaceTUT1";
  systems = [ system1 system2 ];
in
{
  "secret1.age".publicKeys = [ user1 system1 ];
  "secret2.age".publicKeys = users ++ systems;
}
</code></pre>
<p>This file declare that the <code>secret1.age</code> can be decrypted by <code>user1</code> and <code>system1</code>.
<code>secret2.age</code> can be decrypted by all users in <code>users</code> and <code>systems</code>.</p>
<h3 id="075-add-secrets"><a href="#075-add-secrets">0.7.5 Add Secrets</a></h3>
<pre><code class="hljs language-bash"><span class="hljs-comment"># You need to be in the same directory as secrets.nix</span>
<span class="hljs-built_in">cd</span> ./secrets

<span class="hljs-comment"># This will open your editor ($EDITOR) to create the secret</span>
agenix -e secret1.age
</code></pre>
<h3 id="076-add-secrets-to-nixos-configurations"><a href="#076-add-secrets-to-nixos-configurations">0.7.6 Add Secrets to NixOS Configurations</a></h3>
<pre><code class="hljs language-nix">{
  # this will allow you to use the secrets in your NixOS configuration as a string
  age.secrets.secret1.file = ../secrets/secret1.age;
}
</code></pre>
<p>Or,</p>
<pre><code class="hljs language-nix">{
  # this will allow you to access the at the path /etc/secret1 with the correct permissions
  age.secrets.secret1 = {
    file = ../secrets/secret1
    path = "/etc/secret1";;
    mode = "770";
    owner = "nginx";
    group = "nginx";
  };
}
</code></pre>
<h3 id="077-use-secrets"><a href="#077-use-secrets">0.7.7 Use Secrets</a></h3>
<h4 id="0771-use-path-of-secrets"><a href="#0771-use-path-of-secrets">0.7.7.1 Use Path of Secrets</a></h4>
<pre><code class="hljs language-nix">{
  users.users.user1 = {
    isNormalUser = true;
    passwordFile = config.age.secrets.secret1.path;
  };
}
</code></pre>
<h4 id="0772-replace-inplace-strings-with-secrets"><a href="#0772-replace-inplace-strings-with-secrets">0.7.7.2 Replace Inplace Strings With Secrets</a></h4>
<p>Considering that there still might be some modules which doesn't support reading secrets from a file, you could provide a placeholder string instead of a clear-text password and replace this placeholder with the secret provided by Agenix.</p>
<p>In the following example, the Dex module creates the config file /run/dex/config.yaml containing the placeholder string @dex-user-password@. The activation script will read the Agenix secret from config.age.secret.dex-user-password.path and replace the placeholder string with the actual secret.</p>
<pre><code class="hljs language-nix">system.activationScripts."dex-user-secret" = ''
  secret=$(cat "${config.age.secrets.dex-user-password.path}")
  configFile=/run/dex/config.yaml
  ${pkgs.gnused}/bin/sed -i "s#@dex-user-password@#$secret#" "$configFile"
'';
</code></pre>
<h2 id="08-mount-webdav-using-autofs"><a href="#08-mount-webdav-using-autofs">0.8 Mount WebDav Using AutoFS</a></h2>
<p>I found this two links really helpful.</p>
<p><a href="https://askubuntu.com/questions/821123/autofs-and-webdav-how-to-make-them-work-together">https://askubuntu.com/questions/821123/autofs-and-webdav-how-to-make-them-work-together</a></p>
<p><a href="https://www.reddit.com/r/NixOS/comments/b5p6f7/how_do_i_use_davfs2/">https://www.reddit.com/r/NixOS/comments/b5p6f7/how_do_i_use_davfs2/</a></p>
<p>First you need to install <a href="#use-agenix-to-manage-secrets"><code>agenix</code></a> as a way to manage your <code>WebDav</code> secrets.</p>
<p>Then you need to add the following to your <code>configuration.nix</code>.
This will mount your <code>WebDav</code> to <code>/mnt/{{ mount-dir }}</code>.</p>
<pre><code class="hljs language-nix">{
  age.secrets = {
    webdav-secrets = {
      file = ./secrets/{{ your secret file }};
      owner = "root";
      group = "root";
      mode = "600";
      # this is the path where the secret will be mounted
      path = "/etc/davfs2/secrets";
    };
  };

  # put the configuration for davfs2 in the /etc/davfs2 directory
  environment.etc."davfs2/auto.mount" = {
    # rw means read-write, ro means read-only
    # you need to add backslash `\` before ':' and '#' in your url
    text = ''
      {{ mount-dir }} -fstype=davfs,conf=/etc/davfs2/conf,rw {{ your webdav url }}
    '';
    mode = "0440";
  };
  environment.etc."davfs2/conf" = {
    text = ''
      secrets /etc/davfs2/secrets
    '';
    mode = "0440";
  };

  # enable the service
  services.davfs2.enable = true;
  services.autofs = {
    enable = true;
    autoMaster = "/mnt/ /etc/davfs2/auto.mount";
  };
}
</code></pre>
<h2 id="09-clean-the-system--nix-store"><a href="#09-clean-the-system--nix-store">0.9 Clean the System &#x26; Nix Store</a></h2>
<pre><code class="hljs language-nix"># clean journalctl
services.cron = {
  enable = true;
  systemCronJobs = [
    "0 0 * * * journalctl --vacuum-time=7d 1>/dev/null"
  ];
};

# garbange collection check https://nixos.wiki/wiki/Nix_Cookbook#Reclaim_space_on_Nix_install.3F
nix.gc.automatic = true;
nix.settings.auto-optimise-store = true;
</code></pre>
<h2 id="010-enable-the-mosh-server"><a href="#010-enable-the-mosh-server">0.10 Enable the Mosh Server</a></h2>
<pre><code class="hljs language-nix"># Enable mosh, the ssh alternative when client has bad connection
# Opens UDP ports 60000 ... 61000
programs.mosh.enable = true;
networking.firewall.allowedTCPPortRanges = [
  {
    from = 60000;
    to = 61000;
  }
];
networking.firewall.allowedUDPPortRanges = [
  {
    from = 60000;
    to = 61000;
  }
];
</code></pre>
<h2 id="011-enable-fail2ban"><a href="#011-enable-fail2ban">0.11 Enable Fail2Ban</a></h2>
<pre><code class="hljs language-nix">services.fail2ban = {
  enable = true;
  maxretry = 5;
  ignoreIP = [
    "127.0.0.0/8" 
    "10.0.0.0/8" 
    "172.16.0.0/12" 
    "192.168.0.0/16"
    "8.8.8.8"
  ];
};
</code></pre>